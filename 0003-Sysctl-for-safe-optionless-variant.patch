From ac1b1c7780c676514a5d114c9db1ab878c6abe6a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ilpo=20J=C3=A4rvinen?= <ilpo.jarvinen@cs.helsinki.fi>
Date: Mon, 12 Jul 2021 11:28:20 +0300
Subject: [PATCH 3/4] Sysctl for safe optionless variant

---
 include/net/netns/ipv4.h   | 1 +
 net/ipv4/sysctl_net_ipv4.c | 7 +++++++
 net/ipv4/tcp_input.c       | 9 +++++++++
 net/ipv4/tcp_ipv4.c        | 1 +
 4 files changed, 18 insertions(+)

diff --git a/include/net/netns/ipv4.h b/include/net/netns/ipv4.h
index 21b810b59747..3d3c8ca99efe 100644
--- a/include/net/netns/ipv4.h
+++ b/include/net/netns/ipv4.h
@@ -98,6 +98,7 @@ struct netns_ipv4 {
 	int sysctl_tcp_ecn_option;
 	int sysctl_tcp_ecn_option_beacon;
 	int sysctl_tcp_ecn_fallback;
+	int sysctl_tcp_ecn_optionless_safe;
 
 	int sysctl_ip_default_ttl;
 	int sysctl_ip_no_pmtu_disc;
diff --git a/net/ipv4/sysctl_net_ipv4.c b/net/ipv4/sysctl_net_ipv4.c
index 1d7832c5b6d4..ed8838c08277 100644
--- a/net/ipv4/sysctl_net_ipv4.c
+++ b/net/ipv4/sysctl_net_ipv4.c
@@ -687,6 +687,13 @@ static struct ctl_table ipv4_net_table[] = {
 		.mode		= 0644,
 		.proc_handler	= proc_dointvec
 	},
+	{
+		.procname	= "tcp_ecn_optionless_safe",
+		.data		= &init_net.ipv4.sysctl_tcp_ecn_optionless_safe,
+		.maxlen		= sizeof(int),
+		.mode		= 0644,
+		.proc_handler	= proc_dointvec
+	},
 	{
 		.procname	= "ip_dynaddr",
 		.data		= &init_net.ipv4.sysctl_ip_dynaddr,
diff --git a/net/ipv4/tcp_input.c b/net/ipv4/tcp_input.c
index fa8ca22552e5..cf8652aa70f8 100644
--- a/net/ipv4/tcp_input.c
+++ b/net/ipv4/tcp_input.c
@@ -785,6 +785,15 @@ static s32 __tcp_accecn_process(struct sock *sk, const struct sk_buff *skb,
 		return safe_delta;
 	}
 
+	if (tp->saw_accecn_opt == TCP_ACCECN_OPT_COUNTER_SEEN)
+		return delta;
+
+	if (!delta && (sock_net(sk)->ipv4.sysctl_tcp_ecn_optionless_safe & 0x2))
+		return delta;
+
+	if (sock_net(sk)->ipv4.sysctl_tcp_ecn_optionless_safe & 0x1)
+		return safe_delta;
+
 	return delta;
 }
 
diff --git a/net/ipv4/tcp_ipv4.c b/net/ipv4/tcp_ipv4.c
index e33fe065f1d9..40b42d1b0166 100644
--- a/net/ipv4/tcp_ipv4.c
+++ b/net/ipv4/tcp_ipv4.c
@@ -2859,6 +2859,7 @@ static int __net_init tcp_sk_init(struct net *net)
 	net->ipv4.sysctl_tcp_ecn_option = 2;
 	net->ipv4.sysctl_tcp_ecn_option_beacon = 1;
 	net->ipv4.sysctl_tcp_ecn_fallback = 1;
+	net->ipv4.sysctl_tcp_ecn_optionless_safe = 0x2;
 
 	net->ipv4.sysctl_tcp_base_mss = TCP_BASE_MSS;
 	net->ipv4.sysctl_tcp_min_snd_mss = TCP_MIN_SND_MSS;
-- 
2.20.1

